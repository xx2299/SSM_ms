% Read the data
pev1504=ncread('15_4.nc','pev');
pev1504=single(pev1504);
pev1505=ncread('15_5.nc','pev');
pev1505=single(pev1505);
pev1506=ncread('15_6.nc','pev');
pev1506=single(pev1506);
A1504=read_ERA5(pev1504);
A1505=read_ERA5(pev1505);
A1506=read_ERA5(pev1506);
pev1507=ncread('15_7.nc','pev');
pev1507=single(pev1507);
pev1508=ncread('15_8.nc','pev');
pev1508=single(pev1508);
pev1509=ncread('15_9.nc','pev');
pev1509=single(pev1509);
A1507=read_ERA5(pev1507);
A1508=read_ERA5(pev1508);
A1509=read_ERA5(pev1509);
pev1510=ncread('15_10.nc','pev');
pev1510=single(pev1510);
pev1511=ncread('15_11.nc','pev');
pev1511=single(pev1511);
pev1512=ncread('15_12.nc','pev');
pev1512=single(pev1512);
A1510=read_ERA5(pev1510);
A1511=read_ERA5(pev1511);
A1512=read_ERA5(pev1512);
pev1601=ncread('16_1.nc','pev');
pev1601=single(pev1601);
pev1602=ncread('16_2.nc','pev');
pev1602=single(pev1602);
pev1603=ncread('16_3.nc','pev');
pev1603=single(pev1603);
A1601=read_ERA5(pev1601);
A1602=read_ERA5(pev1602);
A1603=read_ERA5(pev1603);
pev1604=ncread('16_4.nc','pev');
pev1604=single(pev1604);
pev1605=ncread('16_5.nc','pev');
pev1605=single(pev1605);
pev1606=ncread('16_6.nc','pev');
pev1606=single(pev1606);
A1604=read_ERA5(pev1604);
A1605=read_ERA5(pev1605);
A1606=read_ERA5(pev1606);
pev1607=ncread('16_7.nc','pev');
pev1607=single(pev1607);
pev1608=ncread('16_8.nc','pev');
pev1608=single(pev1608);
pev1609=ncread('16_9.nc','pev');
pev1609=single(pev1609);
A1607=read_ERA5(pev1607);
A1608=read_ERA5(pev1608);
A1609=read_ERA5(pev1609);
pev1610=ncread('16_10.nc','pev');
pev1610=single(pev1610);
pev1611=ncread('16_11.nc','pev');
pev1611=single(pev1611);
pev1612=ncread('16_12.nc','pev');
pev1612=single(pev1612);
A1610=read_ERA5(pev1610);
A1611=read_ERA5(pev1611);
A1612=read_ERA5(pev1612);
pev1701=ncread('17_1.nc','pev');
pev1701=single(pev1701);
pev1702=ncread('17_2.nc','pev');
pev1702=single(pev1702);
pev1703=ncread('17_3.nc','pev');
pev1703=single(pev1703);
A1701=read_ERA5(pev1701);
A1702=read_ERA5(pev1702);
A1703=read_ERA5(pev1703);
pev1704=ncread('17_4.nc','pev');
pev1704=single(pev1704);
pev1705=ncread('17_5.nc','pev');
pev1705=single(pev1705);
pev1706=ncread('17_6.nc','pev');
pev1706=single(pev1706);
A1704=read_ERA5(pev1704);
A1705=read_ERA5(pev1705);
A1706=read_ERA5(pev1706);
pev1707=ncread('17_7.nc','pev');
pev1707=single(pev1707);
pev1708=ncread('17_8.nc','pev');
pev1708=single(pev1708);
pev1709=ncread('17_9.nc','pev');
pev1709=single(pev1709);
A1707=read_ERA5(pev1707);
A1708=read_ERA5(pev1708);
A1709=read_ERA5(pev1709);
pev1710=ncread('17_10.nc','pev');
pev1710=single(pev1710);
pev1711=ncread('17_11.nc','pev');
pev1711=single(pev1711);
pev1712=ncread('17_12.nc','pev');
pev1712=single(pev1712);
A1710=read_ERA5(pev1710);
A1711=read_ERA5(pev1711);
A1712=read_ERA5(pev1712);
pev1801=ncread('18_1.nc','pev');
pev1801=single(pev1801);
pev1802=ncread('18_2.nc','pev');
pev1802=single(pev1802);
pev1803=ncread('18_3.nc','pev');
pev1803=single(pev1803);
A1801=read_ERA5(pev1801);
A1802=read_ERA5(pev1802);
A1803=read_ERA5(pev1803);
pev1804=ncread('18_4.nc','pev');
pev1804=single(pev1804);
pev1805=ncread('18_5.nc','pev');
pev1805=single(pev1805);
pev1806=ncread('18_6.nc','pev');
pev1806=single(pev1806);
A1804=read_ERA5(pev1804);
A1805=read_ERA5(pev1805);
A1806=read_ERA5(pev1806);
pev1807=ncread('18_7.nc','pev');
pev1807=single(pev1807);
pev1808=ncread('18_8.nc','pev');
pev1808=single(pev1808);
pev1809=ncread('18_9.nc','pev');
pev1809=single(pev1809);
A1807=read_ERA5(pev1807);
A1808=read_ERA5(pev1808);
A1809=read_ERA5(pev1809);
pev1810=ncread('18_10.nc','pev');
pev1810=single(pev1810);
pev1811=ncread('18_11.nc','pev');
pev1811=single(pev1811);
pev1812=ncread('18_12.nc','pev');
pev1812=single(pev1812);
A1810=read_ERA5(pev1810);
A1811=read_ERA5(pev1811);
A1812=read_ERA5(pev1812);
pev1901=ncread('19_1.nc','pev');
pev1901=single(pev1901);
pev1902=ncread('19_2.nc','pev');
pev1902=single(pev1902);
pev1903=ncread('19_3.nc','pev');
pev1903=single(pev1903);
A1901=read_ERA5(pev1901);
A1902=read_ERA5(pev1902);
A1903=read_ERA5(pev1903);
pev1904=ncread('19_4.nc','pev');
pev1904=single(pev1904);
pev1905=ncread('19_5.nc','pev');
pev1905=single(pev1905);
pev1906=ncread('19_6.nc','pev');
pev1906=single(pev1906);
A1904=read_ERA5(pev1904);
A1905=read_ERA5(pev1905);
A1906=read_ERA5(pev1906);
pev1907=ncread('19_7.nc','pev');
pev1907=single(pev1907);
pev1908=ncread('19_8.nc','pev');
pev1908=single(pev1908);
pev1909=ncread('19_9.nc','pev');
pev1909=single(pev1909);
A1907=read_ERA5(pev1907);
A1908=read_ERA5(pev1908);
A1909=read_ERA5(pev1909);
pev1910=ncread('19_10.nc','pev');
pev1910=single(pev1910);
pev1911=ncread('19_11.nc','pev');
pev1911=single(pev1911);
pev1912=ncread('19_12.nc','pev');
pev1912=single(pev1912);
A1910=read_ERA5(pev1910);
A1911=read_ERA5(pev1911);
A1912=read_ERA5(pev1912);
pev2001=ncread('20_1.nc','pev');
pev2001=single(pev2001);
pev2002=ncread('20_2.nc','pev');
pev2002=single(pev2002);
pev2003=ncread('20_3.nc','pev');
pev2003=single(pev2003);
A2001=read_ERA5(pev2001);
A2002=read_ERA5(pev2002);
A2003=read_ERA5(pev2003);
pev2004=ncread('20_4.nc','pev');
pev2004=single(pev2004);
pev2005=ncread('20_5.nc','pev');
pev2005=single(pev2005);
pev2006=ncread('20_6.nc','pev');
pev2006=single(pev2006);
A2004=read_ERA5(pev2004);
A2005=read_ERA5(pev2005);
A2006=read_ERA5(pev2006);
pev2007=ncread('20_7.nc','pev');
pev2007=single(pev2007);
pev2008=ncread('20_8.nc','pev');
pev2008=single(pev2008);
pev2009=ncread('20_9.nc','pev');
pev2009=single(pev2009);
A2007=read_ERA5(pev2007);
A2008=read_ERA5(pev2008);
A2009=read_ERA5(pev2009);
pev2010=ncread('20_10.nc','pev');
pev2010=single(pev2010);
pev2011=ncread('20_11.nc','pev');
pev2011=single(pev2011);
pev2012=ncread('20_12.nc','pev');
pev2012=single(pev2012);
A2010=read_ERA5(pev2010);
A2011=read_ERA5(pev2011);
A2012=read_ERA5(pev2012);
% Evenly split monthly A to 32 chunks
datadir='E:\Obv_2021\ERA5\Ep\data\monthly_A\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
split_num=32;
temp_num=1440*721/split_num;
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    for i=1:split_num
        eval(['A',num2str(m),'_',num2str(i),'=','A_temp(:,temp_num*(i-1)+1:temp_num*i)',';']);
        fileDir='E:\Obv_2021\ERA5\Ep\data\split_A\';
        filename=strcat(fileDir,'A',num2str(m),'_',num2str(i),'.mat');
        save(filename,['A',num2str(m),'_',num2str(i)])
        eval(['clear ','A',num2str(m),'_',num2str(i),';'])
        disp(i)
    end
    disp(m)
end
% Calculate PE_kw for EAR5 data
N=16816;
Fs=8;
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_1\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_1=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_1=[A_1;A_temp];
    disp(m)
end
[EpP1_1,EpP2_1,EpP3_1]=ERA5_P(A_1,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_2\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_2=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_2=[A_2;A_temp];
    disp(m)
end
[EpP1_2,EpP2_2,EpP3_2]=ERA5_P(A_2,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_3\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_3=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_3=[A_3;A_temp];
    disp(m)
end
[EpP1_3,EpP2_3,EpP3_3]=ERA5_P(A_3,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_4\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_4=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_4=[A_4;A_temp];
    disp(m)
end
[EpP1_4,EpP2_4,EpP3_4]=ERA5_P(A_4,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_5\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_5=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_5=[A_5;A_temp];
    disp(m)
end
[EpP1_5,EpP2_5,EpP3_5]=ERA5_P(A_5,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_6\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_6=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_6=[A_6;A_temp];
    disp(m)
end
[EpP1_6,EpP2_6,EpP3_6]=ERA5_P(A_6,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_7\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_7=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_7=[A_7;A_temp];
    disp(m)
end
[EpP1_7,EpP2_7,EpP3_7]=ERA5_P(A_7,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_8\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_8=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_8=[A_8;A_temp];
    disp(m)
end
[EpP1_8,EpP2_8,EpP3_8]=ERA5_P(A_8,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_9\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_9=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_9=[A_9;A_temp];
    disp(m)
end
[EpP1_9,EpP2_9,EpP3_9]=ERA5_P(A_9,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_10\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_10=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_10=[A_10;A_temp];
    disp(m)
end
[EpP1_10,EpP2_10,EpP3_10]=ERA5_P(A_10,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_11\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_11=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_11=[A_11;A_temp];
    disp(m)
end
[EpP1_11,EpP2_11,EpP3_11]=ERA5_P(A_11,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_12\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_12=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_12=[A_12;A_temp];
    disp(m)
end
[EpP1_12,EpP2_12,EpP3_12]=ERA5_P(A_12,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_13\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_13=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_13=[A_13;A_temp];
    disp(m)
end
[EpP1_13,EpP2_13,EpP3_13]=ERA5_P(A_13,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_14\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_14=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_14=[A_14;A_temp];
    disp(m)
end
[EpP1_14,EpP2_14,EpP3_14]=ERA5_P(A_14,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_15\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_15=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_15=[A_15;A_temp];
    disp(m)
end
[EpP1_15,EpP2_15,EpP3_15]=ERA5_P(A_15,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_16\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_16=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_16=[A_16;A_temp];
    disp(m)
end
[EpP1_16,EpP2_16,EpP3_16]=ERA5_P(A_16,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_17\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_17=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_17=[A_17;A_temp];
    disp(m)
end
[EpP1_17,EpP2_17,EpP3_17]=ERA5_P(A_17,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_18\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_18=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_18=[A_18;A_temp];
    disp(m)
end
[EpP1_18,EpP2_18,EpP3_18]=ERA5_P(A_18,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_19\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_19=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_19=[A_19;A_temp];
    disp(m)
end
[EpP1_19,EpP2_19,EpP3_19]=ERA5_P(A_19,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_20\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_20=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_20=[A_20;A_temp];
    disp(m)
end
[EpP1_20,EpP2_20,EpP3_20]=ERA5_P(A_20,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_21\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_21=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_21=[A_21;A_temp];
    disp(m)
end
[EpP1_21,EpP2_21,EpP3_21]=ERA5_P(A_21,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_22\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_22=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_22=[A_22;A_temp];
    disp(m)
end
[EpP1_22,EpP2_22,EpP3_22]=ERA5_P(A_22,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_23\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_23=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_23=[A_23;A_temp];
    disp(m)
end
[EpP1_23,EpP2_23,EpP3_23]=ERA5_P(A_23,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_24\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_24=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_24=[A_24;A_temp];
    disp(m)
end
[EpP1_24,EpP2_24,EpP3_24]=ERA5_P(A_24,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_25\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_25=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_25=[A_25;A_temp];
    disp(m)
end
[EpP1_25,EpP2_25,EpP3_25]=ERA5_P(A_25,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_26\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_26=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_26=[A_26;A_temp];
    disp(m)
end
[EpP1_26,EpP2_26,EpP3_26]=ERA5_P(A_26,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_27\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_27=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_27=[A_27;A_temp];
    disp(m)
end
[EpP1_27,EpP2_27,EpP3_27]=ERA5_P(A_27,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_28\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_28=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_28=[A_28;A_temp];
    disp(m)
end
[EpP1_28,EpP2_28,EpP3_28]=ERA5_P(A_28,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_29\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_29=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_29=[A_29;A_temp];
    disp(m)
end
[EpP1_29,EpP2_29,EpP3_29]=ERA5_P(A_29,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_30\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_30=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_30=[A_30;A_temp];
    disp(m)
end
[EpP1_30,EpP2_30,EpP3_30]=ERA5_P(A_30,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_31\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_31=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_31=[A_31;A_temp];
    disp(m)
end
[EpP1_31,EpP2_31,EpP3_31]=ERA5_P(A_31,N,Fs);
datadir='E:\Obv_2021\ERA5\Ep\data\splice_A\A_32\';
filelist=dir([datadir,'*.mat']);
k=length(filelist);
A_32=[];
for m=1:k
    A_temp=cell2mat(struct2cell(load(strcat(datadir,filelist(m).name))));
    A_32=[A_32;A_temp];
    disp(m)
end
[EpP1_32,EpP2_32,EpP3_32]=ERA5_P(A_32,N,Fs);

% % Calculate ERA5 Pr_kw
EpP1=[EpP1_1,EpP1_2,EpP1_3,EpP1_4,EpP1_5,EpP1_6,EpP1_7,EpP1_8,EpP1_9,EpP1_10,EpP1_11,EpP1_12,EpP1_13,EpP1_14,EpP1_15,EpP1_16,EpP1_17,EpP1_18,EpP1_19,EpP1_20,EpP1_21,EpP1_22,EpP1_23,EpP1_24,EpP1_25,EpP1_26,EpP1_27,EpP1_28,EpP1_29,EpP1_30,EpP1_31,EpP1_32];
EpP2=[EpP2_1,EpP2_2,EpP2_3,EpP2_4,EpP2_5,EpP2_6,EpP2_7,EpP2_8,EpP2_9,EpP2_10,EpP2_11,EpP2_12,EpP2_13,EpP2_14,EpP2_15,EpP2_16,EpP2_17,EpP2_18,EpP2_19,EpP2_20,EpP2_21,EpP2_22,EpP2_23,EpP2_24,EpP2_25,EpP2_26,EpP2_27,EpP2_28,EpP2_29,EpP2_30,EpP2_31,EpP2_32];
EpP3=[EpP3_1,EpP3_2,EpP3_3,EpP3_4,EpP3_5,EpP3_6,EpP3_7,EpP3_8,EpP3_9,EpP3_10,EpP3_11,EpP3_12,EpP3_13,EpP3_14,EpP3_15,EpP3_16,EpP3_17,EpP3_18,EpP3_19,EpP3_20,EpP3_21,EpP3_22,EpP3_23,EpP3_24,EpP3_25,EpP3_26,EpP3_27,EpP3_28,EpP3_29,EpP3_30,EpP3_31,EpP3_32];
% Calculate original ERA5 Pr_kw
ERA5_EpP1=D_rotation(EpP1);
ERA5_EpP2=D_rotation(EpP2);
ERA5_EpP3=D_rotation(EpP3);
% Change the spatial resolution of the ERA5's Pr_kw to the same as SMAP
ERA5_EpP1_t=ERA5_EpP1.';
ERA5_Epp1=reshape(ERA5_EpP1_t,[1038240,1]);
ERA5_EpP2_t=ERA5_EpP2.';
ERA5_Epp2=reshape(ERA5_EpP2_t,[1038240,1]);
ERA5_EpP3_t=ERA5_EpP3.';
ERA5_Epp3=reshape(ERA5_EpP3_t,[1038240,1]);
lon=linspace(-179.95,179.95,1440);
lonERA5=lon.';
ERA5_new_Epp1=ERA5_SMAP_resolution(SMAP1,ERA5_Epp1,latERA5,lonERA5);
ERA5_new_Epp2=ERA5_SMAP_resolution(SMAP2,ERA5_Epp2,latERA5,lonERA5);
ERA5_new_Epp3=ERA5_SMAP_resolution(SMAP3,ERA5_Epp3,latERA5,lonERA5);
% Change ERA5's Pr_kw has same surface coverage as SMAP
EpP1_new=knn_mean(SMF_template,ERA5_new_Epp1,1);
EpP2_new=knn_mean(SMF_template,ERA5_new_Epp2,1);
EpP3_new=knn_mean(SMF_template,ERA5_new_Epp3,1);

% % Functions
function A=read_ERA5(Data)
[~,~,t]=size(Data);
A(t,1038240)=0;
count=1;
for q=1:721
    for p=1:1440
        C=Data(p,q,:);
        A(:,count)=C(:);
        count=count+1;
    end
    disp(q)
end
A=single(A);
end

function ERA5_F=D_rotation(ybar)
tp_1=reshape(ybar,[1440 721]);
tp_2=flipud(tp_1);
tp_F=rot90(tp_2,-1);
a1=tp_F(:,1:720);
a2=tp_F(:,721:1440);
ERA5_F=[a2,a1];
end

function [Prp1,Prp2,Prp3]=ERA5_P(ERA5_A,N,Fs)
F=((1:N)-1)*Fs/N;
x=F(1:N/2);
a=find(abs(x-1/7)<=0.0002);
b=find(abs(x-1/30)<=0.0002);
c=find(abs(x-1/90)<=0.0002);
d=find(abs(x-1/365)<=0.0002);
[~,n]=size(ERA5_A);
Prp1(1,n)=0;
Prp2(1,n)=0;
Prp3(1,n)=0;
count=1;
for i=1:n
    temp=isnan(ERA5_A(:,i));
    if sum(temp)>=16815
        Prp1(1,count)=nan;
        Prp2(1,count)=nan;
        Prp3(1,count)=nan;
    else
        A=ERA5_A(:,i);
        var=sum((A-mean(A)).^2)/length(A);
        Y=fft(A);
        Y=Y(1:(N/2),:);
        Ayy=abs(Y).^2;
        Ayy=Ayy/(N/2)/var;
        X=[ones(length(Ayy),1),x'];
        p1=polyfit(log(X(b:a,2)),log(Ayy(b:a)),1);
        Prp1(1,count)=p1(1);
        p2=polyfit(log(X(c:b,2)),log(Ayy(c:b)),1);
        Prp2(1,count)=p2(1);
        p3=polyfit(log(X(d:c,2)),log(Ayy(d:c)),1);
        Prp3(1,count)=p3(1);
    end
    disp(i);
    count=count+1;
end
end

function [ERA5_F]=ERA5_SMAP_resolution(SMAP_f,ERA5_f,latData,lonData)
count=1;
for i=1:721
    ERA5_lat(count:count+1439,1)=latData(i,1);
    ERA5_lon(count:count+1439,1)=lonData;
    count=count+1440;
end
ERA5_lat=single(ERA5_lat);
ERA5_lon=single(ERA5_lon);
ERA5=[ERA5_lat,ERA5_lon,ERA5_f];
[m1,~]=size(ERA5);
[m2,~]=size(SMAP_f);
dif(m1,1)=0;
ERA5_new_f(m2,1)=0;
for j=1:m2
    count=1;
    for i=1:m1
        dif(count,1)=abs(ERA5(i,1)-SMAP_f(j,1))+abs(ERA5(i,2)-SMAP_f(j,2));
        count=count+1;
    end
    [~,idx]=min(dif);
    ERA5_new_f(j,1)=ERA5(idx,3);
    disp(j)
end
new_f=reshape(ERA5_new_f,[964,406]);
ERA5_F=new_f.';
end

function [n_mF]=knn_mean(obv_F,n_mF,p_num)
% % logistic difference between model and SMAP (0:same, 1:pixel non-NaN for model but NaN for SMAP(1-0=1), -1:pixel NaN for model but non-NaN for SMAP (0-1=-1))
logic_temp_obv=single(~isnan(obv_F));
logic_temp_modelf=single(~isnan(n_mF));
diff_temp=logic_temp_modelf-logic_temp_obv;
n_mF(diff_temp==1)=nan;   % change non-NaN for model but NaN for SMAP to NaN in model
diff_num=length(find(diff_temp==-1));
while diff_num>0
    % % change NaN for model but non-NaN for SMAP to non-NaN in model (KNN-mean)
    dim=size(obv_F);
    [lat,lon]=find(diff_temp==-1);
    idx=find(diff_temp==-1);
    idx_temp=[lat,lon,idx];
    % % find corresponding index for pixels as non-NaN in SMAP
    p_c_lt=find(lon==1 & lat==1);   % left-top-corner pixel
    p_c_lb=find(lon==1 & lat==dim(1));   % left-bottom-corner pixel
    p_c_rt=find(lon==dim(2) & lat==1);   % right-top-corner pixel
    p_c_rb=find(lon==dim(2) & lat==dim(1));   % right-bottom-corner pixel
    p_t=find((lat==1 & lon~=1 & lon~=dim(2)));   % top line pixels (without corner)
    p_b=find((lat==dim(1) & lon~=1 & lon~=dim(2)));   % bottom line pixels (without corner)
    p_l=find((lon==1 & lat~=1 & lat~=dim(1)));   % left line pixels (without corner)
    p_r=find((lon==dim(2) & lat~=1 & lat~=dim(1)));   % right line pixels (without corner)
    p_o=find((lat~=1 & lat~=dim(1) & lon~=1 & lon~=dim(2)));   % other pixels
    % % change pixels with NaN for model but non-NaN for SMAP to non-NaN in model (four corners)
    n_mF(idx(p_c_lt))=nanmean([n_mF(lat(p_c_lt),lon(p_c_lt)+p_num),n_mF(lat(p_c_lt)+p_num,lon(p_c_lt)),n_mF(lat(p_c_lt)+p_num,lon(p_c_lt)+1)]);
    n_mF(idx(p_c_lb))=nanmean([n_mF(lat(p_c_lb)-p_num,lon(p_c_lb)),n_mF(lat(p_c_lb),lon(p_c_lb)+p_num),n_mF(lat(p_c_lb)-p_num,lon(p_c_lb)+1)]);
    n_mF(idx(p_c_rt))=nanmean([n_mF(lat(p_c_rt),lon(p_c_rt)-p_num),n_mF(lat(p_c_rt)+p_num,lon(p_c_rt)),n_mF(lat(p_c_rt)+p_num,lon(p_c_rt)-1)]);
    n_mF(idx(p_c_rb))=nanmean([n_mF(lat(p_c_rb)-p_num,lon(p_c_rb)),n_mF(lat(p_c_rb),lon(p_c_rb)-p_num),n_mF(lat(p_c_rb)-p_num,lon(p_c_rb)-1)]);
    % % change pixels with NaN for model but non-NaN for SMAP to non-NaN in model (Outermost circle)
    % % n_t, n_b, n_l, n_r: number of pixels in top, bottom, left, right line
    for n_t=1:length(p_t)
        if lon(p_t(n_t))-p_num>=1 && lat(p_t(n_t))+p_num<=dim(1) && lon(p_t(n_t))+p_num<=dim(2)
            n_mF(idx(p_t(n_t)))=nanmean([n_mF(lat(p_t(n_t)),lon(p_t(n_t))-p_num),n_mF(lat(p_t(n_t))+p_num,lon(p_t(n_t))),n_mF(lat(p_t(n_t)),lon(p_t(n_t))+p_num),n_mF(lat(p_t(n_t))+p_num,lon(p_t(n_t))-p_num),n_mF(lat(p_t(n_t))+p_num,lon(p_t(n_t))+p_num)]);
        elseif lon(p_t(n_t))-p_num<1
            n_mF(idx(p_t(n_t)))=nanmean([n_mF(lat(p_t(n_t))+p_num,lon(p_t(n_t))),n_mF(lat(p_t(n_t)),lon(p_t(n_t))+p_num),n_mF(lat(p_t(n_t))+p_num,lon(p_t(n_t))+p_num)]);
        elseif lat(p_t(n_t))+p_num>dim(1)
            n_mF(idx(p_t(n_t)))=nanmean([n_mF(lat(p_t(n_t)),lon(p_t(n_t))-p_num),n_mF(lat(p_t(n_t)),lon(p_t(n_t))+p_num)]);
        elseif lon(p_t(n_t))+p_num>dim(2)
            n_mF(idx(p_t(n_t)))=nanmean([n_mF(lat(p_t(n_t)),lon(p_t(n_t))-p_num),n_mF(lat(p_t(n_t))+p_num,lon(p_t(n_t))),n_mF(lat(p_t(n_t))+p_num,lon(p_t(n_t))-p_num)]);
        end
    end
    for n_b=1:length(p_b)
        if lat(p_b(n_b))-p_num>=1 && lon(p_b(n_b))-p_num>=1 && lon(p_b(n_b))+p_num<=dim(2)
            n_mF(idx(p_b(n_b)))=nanmean([n_mF(lat(p_b(n_b)),lon(p_b(n_b))-p_num),n_mF(lat(p_b(n_b))-p_num,lon(p_b(n_b))),n_mF(lat(p_b(n_b)),lon(p_b(n_b))+p_num),n_mF(lat(p_b(n_b))-p_num,lon(p_b(n_b))-p_num),n_mF(lat(p_b(n_b))-p_num,lon(p_b(n_b))+p_num)]);
        elseif lat(p_b(n_b))-p_num<1
            n_mF(idx(p_b(n_b)))=nanmean([n_mF(lat(p_b(n_b)),lon(p_b(n_b))-p_num),n_mF(lat(p_b(n_b)),lon(p_b(n_b))+p_num)]);
        elseif lon(p_b(n_b))-p_num<1
            n_mF(idx(p_b(n_b)))=nanmean([n_mF(lat(p_b(n_b))-p_num,lon(p_b(n_b))),n_mF(lat(p_b(n_b)),lon(p_b(n_b))+p_num),n_mF(lat(p_b(n_b))-p_num,lon(p_b(n_b))+p_num)]);
        elseif lon(p_b(n_b))+p_num>dim(2)
            n_mF(idx(p_b(n_b)))=nanmean([n_mF(lat(p_b(n_b)),lon(p_b(n_b))-p_num),n_mF(lat(p_b(n_b))-p_num,lon(p_b(n_b))),n_mF(lat(p_b(n_b))-p_num,lon(p_b(n_b))-p_num)]);
        end
    end
    for n_l=1:length(p_l)
        if lat(p_l(n_l))-p_num>=1 && lat(p_l(n_l))+p_num<=dim(1) && lon(p_l(n_l))+p_num<=dim(2)
            n_mF(idx(p_l(n_l)))=nanmean([n_mF(lat(p_l(n_l))-p_num,lon(p_l(n_l))),n_mF(lat(p_l(n_l)),lon(p_l(n_l))+p_num),n_mF(lat(p_l(n_l))+p_num,lon(p_l(n_l))),n_mF(lat(p_l(n_l))-p_num,lon(p_l(n_l))+p_num),n_mF(lat(p_l(n_l))+p_num,lon(p_l(n_l))+p_num)]);
        elseif lat(p_l(n_l))-p_num<1
            n_mF(idx(p_l(n_l)))=nanmean([n_mF(lat(p_l(n_l)),lon(p_l(n_l))+p_num),n_mF(lat(p_l(n_l))+p_num,lon(p_l(n_l))),n_mF(lat(p_l(n_l))+p_num,lon(p_l(n_l))+p_num)]);
        elseif lat(p_l(n_l))+p_num>dim(1)
            n_mF(idx(p_l(n_l)))=nanmean([n_mF(lat(p_l(n_l))-p_num,lon(p_l(n_l))),n_mF(lat(p_l(n_l)),lon(p_l(n_l))+p_num),n_mF(lat(p_l(n_l))-p_num,lon(p_l(n_l))+p_num)]);
        elseif lon(p_l(n_l))+p_num>dim(2)
            n_mF(idx(p_l(n_l)))=nanmean([n_mF(lat(p_l(n_l))-p_num,lon(p_l(n_l))),n_mF(lat(p_l(n_l))+p_num,lon(p_l(n_l)))]);
        end
    end
    for n_r=1:length(p_r)
        if lat(p_r(n_r))-p_num>=1 && lon(p_r(n_r))-p_num>=1 && lat(p_r(n_r))+p_num<=dim(1)
            n_mF(idx(p_r(n_r)))=nanmean([n_mF(lat(p_r(n_r))-p_num,lon(p_r(n_r))),n_mF(lat(p_r(n_r)),lon(p_r(n_r))-p_num),n_mF(lat(p_r(n_r))+p_num,lon(p_r(n_r))),n_mF(lat(p_r(n_r))-p_num,lon(p_r(n_r))-p_num),n_mF(lat(p_r(n_r))+p_num,lon(p_r(n_r))-p_num)]);
        elseif lat(p_r(n_r))-p_num<1
            n_mF(idx(p_r(n_r)))=nanmean([n_mF(lat(p_r(n_r)),lon(p_r(n_r))-p_num),n_mF(lat(p_r(n_r))+p_num,lon(p_r(n_r))),n_mF(lat(p_r(n_r))+p_num,lon(p_r(n_r))-p_num)]);
        elseif lon(p_r(n_r))-p_num<1
            n_mF(idx(p_r(n_r)))=nanmean([n_mF(lat(p_r(n_r))-p_num,lon(p_r(n_r))),n_mF(lat(p_r(n_r))+p_num,lon(p_r(n_r)))]);
        elseif lat(p_r(n_r))+p_num>dim(1)
            n_mF(idx(p_r(n_r)))=nanmean([n_mF(lat(p_r(n_r))-p_num,lon(p_r(n_r))),n_mF(lat(p_r(n_r)),lon(p_r(n_r))-p_num),n_mF(lat(p_r(n_r))-p_num,lon(p_r(n_r))-p_num)]);
        end
    end
    % % change pixels with NaN for model but non-NaN for SMAP to non-NaN in model (others in center)
    % % n_o: number of pixels in center (i.e., other pixels)
    for n_o=1:length(p_o)
        if lat(p_o(n_o))-p_num>=1 && lon(p_o(n_o))-p_num>=1 && lat(p_o(n_o))+p_num<=dim(1) && lon(p_o(n_o))+p_num<=dim(2)
            n_mF(idx(p_o(n_o)))=nanmean([n_mF(lat(p_o(n_o)),lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o)),lon(p_o(n_o))+p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))+p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))+p_num)]);
        elseif lat(p_o(n_o))-p_num<1
            n_mF(idx(p_o(n_o)))=nanmean([n_mF(lat(p_o(n_o)),lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o)),lon(p_o(n_o))+p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))+p_num)]);
        elseif lon(p_o(n_o))-p_num<1
            n_mF(idx(p_o(n_o)))=nanmean([n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o)),lon(p_o(n_o))+p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))+p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))+p_num)]);
        elseif lat(p_o(n_o))+p_num>dim(1)
            n_mF(idx(p_o(n_o)))=nanmean([n_mF(lat(p_o(n_o)),lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o)),lon(p_o(n_o))+p_num),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))+p_num)]);
        elseif lon(p_o(n_o))+p_num>dim(2)
            n_mF(idx(p_o(n_o)))=nanmean([n_mF(lat(p_o(n_o)),lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))),n_mF(lat(p_o(n_o))-p_num,lon(p_o(n_o))-p_num),n_mF(lat(p_o(n_o))+p_num,lon(p_o(n_o))-p_num)]);
        end
    end
    % % Reculculate diff_num to check whether equals to 0
    logic_temp_modelf=single(~isnan(n_mF));
    diff_temp=logic_temp_modelf-logic_temp_obv;
    diff_num=length(find(diff_temp==-1));
    disp(['diff_num:',num2str(diff_num)])
    p_num=p_num+1;
    disp(['p_num:',num2str(p_num)])
end
end